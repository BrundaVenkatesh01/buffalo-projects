rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function hasWorkspaceAccess(workspaceCode) {
      return isAuthenticated() &&
             exists(/databases/(default)/documents/workspaces/$(workspaceCode)) &&
             (get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.ownerId == request.auth.uid ||
              get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.isPublic == true ||
              request.auth.uid in get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.collaborators);
    }

    function isValidFileSize(maxSizeInMB) {
      return request.resource.size <= maxSizeInMB * 1024 * 1024;
    }

    function isValidFileType(allowedTypes) {
      return request.resource.contentType in allowedTypes;
    }

    // User profile images
    match /profile_images/{userId}/{fileName} {
      // Allow read if authenticated (for displaying user avatars)
      allow read: if isAuthenticated();

      // Allow write only for the user's own profile image
      allow write: if isOwner(userId) &&
                       isValidFileSize(5) && // 5MB limit
                       isValidFileType(['image/jpeg', 'image/png', 'image/webp']);

      // Allow delete only by the owner
      allow delete: if isOwner(userId);
    }

    // Cover images for showcase projects
    // Note: workspaceCode in the path is the project code, but Firestore document IDs may differ
    // We use path-based authorization: users can only write to their own userId folder
    match /covers/{userId}/{workspaceCode}/{fileName} {
      // Public read access for published projects
      allow read: if true;

      // Write: user can only write to their own covers folder
      // The userId in the path must match the authenticated user
      allow write: if isOwner(userId) &&
                       isValidFileSize(5) && // 5MB limit
                       isValidFileType(['image/jpeg', 'image/png', 'image/webp']);

      // Delete: only the owner of the folder (userId must match)
      allow delete: if isOwner(userId);
    }

    // Project images (screenshots, diagrams, etc.)
    // Note: workspaceCode in the path is the project code, but Firestore document IDs may differ
    // We use path-based authorization: users can only write to their own userId folder
    match /project-images/{userId}/{workspaceCode}/{fileName} {
      // Read access: public (cover images and project screenshots are displayable)
      // The actual visibility control happens at the app layer via workspace.visibility
      allow read: if true;

      // Write: user can only write to their own project-images folder
      // The userId in the path must match the authenticated user
      allow write: if isOwner(userId) &&
                       isValidFileSize(10) && // 10MB limit
                       isValidFileType(['image/jpeg', 'image/png', 'image/webp', 'image/gif']);

      // Delete: only the owner of the folder (userId must match)
      allow delete: if isOwner(userId);
    }

    // Evidence documents for workspaces
    // Note: workspaceCode here is the Firestore document ID
    match /evidence/{userId}/{workspaceCode}/{fileName} {
      // Read access: authenticated users can read their own evidence, or evidence from public workspaces
      allow read: if isAuthenticated() &&
                     (request.auth.uid == userId || hasWorkspaceAccess(workspaceCode));

      // Write access: user can only write to their own evidence folder
      // The userId in the path must match the authenticated user
      allow write: if isOwner(userId) && isValidFileSize(100); // 100MB limit

      // Delete: only the owner of the evidence (userId must match)
      allow delete: if isOwner(userId);
    }

    // Workspace documents
    match /documents/{workspaceCode}/{fileName} {
      // Read access: same as workspace access
      allow read: if hasWorkspaceAccess(workspaceCode);

      // Write access: workspace owner or collaborators with edit permissions
      allow write: if isAuthenticated() &&
                       exists(/databases/(default)/documents/workspaces/$(workspaceCode)) &&
                       (get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.ownerId == request.auth.uid ||
                        (request.auth.uid in get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.collaborators &&
                         get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.collaborationSettings.editPermissions == 'collaborators')) &&
                       isValidFileSize(100) && // 100MB limit per file
                       isValidFileType([
                         'application/pdf',
                         'text/plain',
                         'text/markdown',
                         'application/msword',
                         'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                         'text/csv',
                         'application/vnd.ms-excel',
                         'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                         'image/jpeg',
                         'image/png',
                         'image/webp',
                         'image/svg+xml'
                       ]);

      // Delete: only workspace owner
      allow delete: if isAuthenticated() &&
                        exists(/databases/(default)/documents/workspaces/$(workspaceCode)) &&
                        get(/databases/(default)/documents/workspaces/$(workspaceCode)).data.ownerId == request.auth.uid;
    }

    // Class materials (for teachers)
    match /class_materials/{classCode}/{fileName} {
      // Read: students in the class or the teacher
      allow read: if isAuthenticated() &&
                      exists(/databases/(default)/documents/classes/$(classCode)) &&
                      (get(/databases/(default)/documents/classes/$(classCode)).data.ownerId == request.auth.uid ||
                       request.auth.uid in get(/databases/(default)/documents/classes/$(classCode)).data.studentIds);

      // Write/Delete: only the teacher
      allow write, delete: if isAuthenticated() &&
                               exists(/databases/(default)/documents/classes/$(classCode)) &&
                               get(/databases/(default)/documents/classes/$(classCode)).data.ownerId == request.auth.uid &&
                               isValidFileSize(50); // 50MB limit for class materials
    }

    // Assignment submissions
    match /submissions/{classCode}/{assignmentId}/{studentId}/{fileName} {
      // Read: student who submitted or the teacher
      allow read: if isAuthenticated() && (
        request.auth.uid == studentId ||
        (exists(/databases/(default)/documents/classes/$(classCode)) &&
         get(/databases/(default)/documents/classes/$(classCode)).data.ownerId == request.auth.uid)
      );

      // Write: only the student submitting
      allow write: if isAuthenticated() &&
                       request.auth.uid == studentId &&
                       exists(/databases/(default)/documents/classes/$(classCode)) &&
                       request.auth.uid in get(/databases/(default)/documents/classes/$(classCode)).data.studentIds &&
                       isValidFileSize(25); // 25MB limit for submissions

      // Delete: student can delete their own submissions (before deadline)
      allow delete: if isAuthenticated() && request.auth.uid == studentId;
    }

    // Public project assets (read-only after upload)
    match /public_assets/{assetId} {
      allow read: if true; // Public read access

      // Write: only authenticated users for their own workspace assets
      allow write: if isAuthenticated() &&
                       isValidFileSize(10) && // 10MB limit for public assets
                       isValidFileType(['image/jpeg', 'image/png', 'image/webp']);

      allow delete: if false; // Prevent deletion of public assets
    }

    // Temporary uploads (for processing)
    match /temp_uploads/{userId}/{fileName} {
      // Only the user can access their temp uploads
      allow read, write, delete: if isOwner(userId) &&
                                     isValidFileSize(100); // 100MB limit

      // Auto-cleanup: temp files should be moved or deleted within 24 hours
    }

    // System backups and exports (admin only)
    match /system/{path=**} {
      allow read, write: if false; // Only server-side functions
    }

    // Default deny rule
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}